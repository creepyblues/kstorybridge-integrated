import{j as e}from"./ui-DHaiO8z9.js";import{r as m}from"./vendor-BZF0HjbR.js";import{B as w,C as F,a as B,b as H,c as L,p as W,q as z,r as C,s as h,t as P,v as p,S as V,i as J,j as O,k as Y,l as G}from"./shared-oRVCA-__.js";import{A as K}from"./AdminLayout-CwNS1qxs.js";import{s as u}from"./index-DGmbjBI7.js";import{u as o}from"./index-DaSXcfrj.js";import{R as v,f as Q,a as X,n as Z}from"./icons-BVWbeyA4.js";import"./utils-CfDMlrKu.js";import"./router-DmKwpzBq.js";import"./backend-DY5GQkp5.js";function ce(){const[b,d]=m.useState([]),[x,y]=m.useState(!1),[k,_]=m.useState(new Set),[f,g]=m.useState(new Map),[E,S]=m.useState(new Set),T=["invited","basic","pro","suite"],A={invited:"bg-gray-100 text-gray-700",basic:"bg-blue-100 text-blue-700",pro:"bg-purple-100 text-purple-700",suite:"bg-amber-100 text-amber-700"};m.useEffect(()=>{N()},[]);const N=async()=>{try{y(!0);const{data:r,error:n}=await u.from("user_buyers_with_email").select("*").order("created_at",{ascending:!1});if(!n&&r){d(r);return}n&&console.log("Note: user_buyers_with_email view not found, using fallback method");const{data:t,error:a}=await u.from("user_buyers").select("id, email, full_name, tier, requested, created_at, user_id").order("created_at",{ascending:!1});if(!a&&t&&t.length>0&&t[0]&&"email"in t[0]&&t[0].email){console.log("Using user_buyers table with email field");const c=t.map(l=>({id:l.id,user_id:l.user_id||l.id,email:l.email,full_name:l.full_name||"Unknown",tier:l.tier,requested:l.requested,created_at:l.created_at}));d(c);return}const{data:s,error:i}=await u.from("user_buyers").select("*").order("created_at",{ascending:!1});if(i)throw i;if(!s||s.length===0){d([]);return}const D=s.map(c=>{const l=c.user_id||c.id,j=l?String(l):"unknown",U=j.length>8?j.substring(0,8):j;return{...c,user_id:l,email:c.email||`user_${U}@kstorybridge.com`,full_name:c.full_name||`User ${U}`}});d(D),console.log("Using placeholder emails. To see real emails, run the database migration."),o.info("Using placeholder emails. Run the database migration for real email addresses.")}catch(r){console.error("Error loading users:",r),o.error("Failed to load users")}finally{y(!1)}},q=(r,n)=>{g(t=>{const a=new Map(t);return a.set(r,n),a})},M=async r=>{const n=f.get(r);if(n)try{_(a=>new Set(a).add(r));const{error:t}=await u.from("user_buyers").update({tier:n}).eq("id",r);if(t)throw t;d(a=>a.map(s=>s.id===r?{...s,tier:n}:s)),g(a=>{const s=new Map(a);return s.delete(r),s}),o.success("User tier updated successfully")}catch(t){console.error("Error updating user tier:",t),o.error("Failed to update user tier")}finally{_(t=>{const a=new Set(t);return a.delete(r),a})}},R=r=>new Date(r).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),$=async(r,n)=>{var t;try{S(s=>new Set(s).add(r));const{error:a}=await u.from("user_buyers").update({tier:"basic"}).eq("id",r);if(a)throw a;try{const{data:s,error:i}=await u.functions.invoke("send-approval-email",{body:{email:n}});i?(console.error("Edge function error:",i),o.error(`User approved but email failed: ${i.message||"Unknown error"}`)):(console.log("Email function response:",s),s!=null&&s.success?o.success(`✅ User approved and email sent via Resend! (ID: ${((t=s.emailId)==null?void 0:t.substring(0,8))||"N/A"})`):(console.error("Email function error:",s),o.error(`❌ User approved but email failed: ${s.message||"Unknown error"}`)))}catch(s){console.error("Failed to invoke email function:",s),o.error(`User approved but email failed: ${s.message||"Unknown error"}`)}d(s=>s.map(i=>i.id===r?{...i,tier:"basic"}:i)),g(s=>{const i=new Map(s);return i.delete(r),i})}catch(a){console.error("Error approving user:",a),o.error("Failed to approve user")}finally{S(a=>{const s=new Set(a);return s.delete(r),s})}};return e.jsx(K,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-midnight-ink",children:"User Approval"}),e.jsx("p",{className:"text-sm text-midnight-ink-600 mt-1",children:"Manage user tiers and approve access requests"})]}),e.jsxs(w,{onClick:N,variant:"outline",disabled:x,children:[e.jsx(v,{className:`h-4 w-4 mr-2 ${x?"animate-spin":""}`}),"Refresh"]})]}),e.jsxs(F,{children:[e.jsx(B,{children:e.jsx(H,{children:"Buyer Users"})}),e.jsx(L,{children:x?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hanok-teal"})}):b.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No buyer users found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(W,{children:[e.jsx(z,{children:e.jsxs(C,{children:[e.jsx(h,{children:"Email"}),e.jsx(h,{children:"Current Tier"}),e.jsx(h,{children:"Change Tier"}),e.jsx(h,{children:"Requested Access"}),e.jsx(h,{children:"Joined"}),e.jsx(h,{children:"Action"})]})}),e.jsx(P,{children:b.map(r=>{const n=f.has(r.id),t=f.get(r.id),a=k.has(r.id),s=E.has(r.id);return e.jsxs(C,{children:[e.jsx(p,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[r.email,r.tier==="invited"&&e.jsx(w,{size:"sm",variant:"default",onClick:()=>$(r.id,r.email),disabled:s,className:"bg-green-600 hover:bg-green-700",children:s?e.jsx(v,{className:"h-3 w-3 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"Approve"]})})]})}),e.jsx(p,{children:r.tier?e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${A[r.tier]}`,children:r.tier.toUpperCase()}):e.jsx("span",{className:"text-gray-400",children:"Not set"})}),e.jsx(p,{children:e.jsxs(V,{value:t||r.tier||"",onValueChange:i=>q(r.id,i),disabled:a,children:[e.jsx(J,{className:"w-32",children:e.jsx(O,{placeholder:"Select tier"})}),e.jsx(Y,{children:T.map(i=>e.jsx(G,{value:i,children:i.charAt(0).toUpperCase()+i.slice(1)},i))})]})}),e.jsx(p,{children:r.requested?e.jsxs("span",{className:"text-green-600 flex items-center",children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Yes"]}):e.jsx("span",{className:"text-gray-400",children:"No"})}),e.jsx(p,{children:R(r.created_at)}),e.jsx(p,{children:e.jsx(w,{size:"sm",onClick:()=>M(r.id),disabled:!n||a,variant:n?"default":"outline",children:a?e.jsx(v,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Save"]})})})]},r.id)})})]})})})]})]})})}export{ce as default};
