import{j as e}from"./ui-DHaiO8z9.js";import{r as m}from"./vendor-BZF0HjbR.js";import{B as v,C as F,a as K,b as H,c as L,p as O,q as W,r as k,s as p,t as Y,v as u,S as z,i as P,j as V,k as G,l as J}from"./shared-oRVCA-__.js";import{A as Q}from"./AdminLayout-nbEZqzxn.js";import{s as h}from"./index-51_7LTNa.js";import{u as l}from"./index-DaSXcfrj.js";import{R as b,f as X,a as Z,n as I}from"./icons-BVWbeyA4.js";import"./utils-CfDMlrKu.js";import"./router-DmKwpzBq.js";import"./backend-DY5GQkp5.js";function de(){const[y,d]=m.useState([]),[f,S]=m.useState(!1),[T,C]=m.useState(new Set),[x,j]=m.useState(new Map),[E,_]=m.useState(new Set),A=["invited","basic","pro","suite"],$={invited:"bg-gray-100 text-gray-700",basic:"bg-blue-100 text-blue-700",pro:"bg-purple-100 text-purple-700",suite:"bg-amber-100 text-amber-700"};m.useEffect(()=>{U()},[]);const U=async()=>{try{S(!0);const{data:s,error:i}=await h.from("user_buyers_with_email").select("*").order("created_at",{ascending:!1});if(!i&&s){d(s);return}i&&console.log("Note: user_buyers_with_email view not found, using fallback method");const{data:t,error:a}=await h.from("user_buyers").select("id, email, full_name, tier, requested, created_at, user_id").order("created_at",{ascending:!1});if(!a&&t&&t.length>0&&t[0]&&"email"in t[0]&&t[0].email){console.log("Using user_buyers table with email field");const c=t.map(o=>({id:o.id,user_id:o.user_id||o.id,email:o.email,full_name:o.full_name||"Unknown",tier:o.tier,requested:o.requested,created_at:o.created_at}));d(c);return}const{data:r,error:n}=await h.from("user_buyers").select("*").order("created_at",{ascending:!1});if(n)throw n;if(!r||r.length===0){d([]);return}const D=r.map(c=>{const o=c.user_id||c.id,w=o?String(o):"unknown",N=w.length>8?w.substring(0,8):w;return{...c,user_id:o,email:c.email||`user_${N}@kstorybridge.com`,full_name:c.full_name||`User ${N}`}});d(D),console.log("Using placeholder emails. To see real emails, run the database migration."),l.info("Using placeholder emails. Run the database migration for real email addresses.")}catch(s){console.error("Error loading users:",s),l.error("Failed to load users")}finally{S(!1)}},B=(s,i)=>{j(t=>{const a=new Map(t);return a.set(s,i),a})},R=async s=>{const i=x.get(s);if(i)try{C(a=>new Set(a).add(s));const{error:t}=await h.from("user_buyers").update({tier:i}).eq("id",s);if(t)throw t;d(a=>a.map(r=>r.id===s?{...r,tier:i}:r)),j(a=>{const r=new Map(a);return r.delete(s),r}),l.success("User tier updated successfully")}catch(t){console.error("Error updating user tier:",t),l.error("Failed to update user tier")}finally{C(t=>{const a=new Set(t);return a.delete(s),a})}},q=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),g=s=>{const i=encodeURIComponent("Your KStoryBridge Account Has Been Approved!"),t=encodeURIComponent(`Congratulations!

Your account has been approved and you can now navigate K Content ready for your review.

Explore our curated collection of Korean stories, connect with creators, and discover content perfect for your needs.

Get started: https://dashboard.kstorybridge.com

Best regards,
The KStoryBridge Team

© 2025 KStoryBridge. All rights reserved.`),a=`mailto:${s}?subject=${i}&body=${t}`;window.open(a,"_blank"),l.info(`Opening email client to send approval email to ${s}`)},M=async(s,i)=>{var t;try{_(r=>new Set(r).add(s));const{error:a}=await h.from("user_buyers").update({tier:"basic"}).eq("id",s);if(a)throw a;try{const{data:r,error:n}=await h.functions.invoke("send-approval-email",{body:{email:i}});n?(console.error("Edge function error:",n),l.error(`Email function error: ${n.message||"Unknown error"}`),g(i)):(console.log("Email function response:",r),r!=null&&r.success?r.method==="resend"?l.success(`✅ User approved and email sent via Resend! (ID: ${((t=r.emailId)==null?void 0:t.substring(0,8))||"N/A"})`):r.method==="simulation"?(l.warning("⚠️ User approved! Email in simulation mode - opening email client for manual sending."),setTimeout(()=>g(i),1e3)):l.success("✅ User approved and email sent successfully!"):(console.error("Email function returned unsuccessful response:",r),l.warning("⚠️ User approved but email sending failed. Opening email client."),g(i)))}catch(r){console.error("Failed to invoke email function:",r),l.error(`Failed to invoke email function: ${r.message||"Unknown error"}`),g(i)}d(r=>r.map(n=>n.id===s?{...n,tier:"basic"}:n)),j(r=>{const n=new Map(r);return n.delete(s),n})}catch(a){console.error("Error approving user:",a),l.error("Failed to approve user")}finally{_(a=>{const r=new Set(a);return r.delete(s),r})}};return e.jsx(Q,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-midnight-ink",children:"User Approval"}),e.jsx("p",{className:"text-sm text-midnight-ink-600 mt-1",children:"Manage user tiers and approve access requests"})]}),e.jsxs(v,{onClick:U,variant:"outline",disabled:f,children:[e.jsx(b,{className:`h-4 w-4 mr-2 ${f?"animate-spin":""}`}),"Refresh"]})]}),e.jsxs(F,{children:[e.jsx(K,{children:e.jsx(H,{children:"Buyer Users"})}),e.jsx(L,{children:f?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hanok-teal"})}):y.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No buyer users found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(O,{children:[e.jsx(W,{children:e.jsxs(k,{children:[e.jsx(p,{children:"Email"}),e.jsx(p,{children:"Current Tier"}),e.jsx(p,{children:"Change Tier"}),e.jsx(p,{children:"Requested Access"}),e.jsx(p,{children:"Joined"}),e.jsx(p,{children:"Action"})]})}),e.jsx(Y,{children:y.map(s=>{const i=x.has(s.id),t=x.get(s.id),a=T.has(s.id),r=E.has(s.id);return e.jsxs(k,{children:[e.jsx(u,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.email,s.tier==="invited"&&e.jsx(v,{size:"sm",variant:"default",onClick:()=>M(s.id,s.email),disabled:r,className:"bg-green-600 hover:bg-green-700",children:r?e.jsx(b,{className:"h-3 w-3 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-3 w-3 mr-1"}),"Approve"]})})]})}),e.jsx(u,{children:s.tier?e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${$[s.tier]}`,children:s.tier.toUpperCase()}):e.jsx("span",{className:"text-gray-400",children:"Not set"})}),e.jsx(u,{children:e.jsxs(z,{value:t||s.tier||"",onValueChange:n=>B(s.id,n),disabled:a,children:[e.jsx(P,{className:"w-32",children:e.jsx(V,{placeholder:"Select tier"})}),e.jsx(G,{children:A.map(n=>e.jsx(J,{value:n,children:n.charAt(0).toUpperCase()+n.slice(1)},n))})]})}),e.jsx(u,{children:s.requested?e.jsxs("span",{className:"text-green-600 flex items-center",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Yes"]}):e.jsx("span",{className:"text-gray-400",children:"No"})}),e.jsx(u,{children:q(s.created_at)}),e.jsx(u,{children:e.jsx(v,{size:"sm",onClick:()=>R(s.id),disabled:!i||a,variant:i?"default":"outline",children:a?e.jsx(b,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"Save"]})})})]},s.id)})})]})})})]})]})})}export{de as default};
