import{j as e}from"./ui-DHaiO8z9.js";import{r as m}from"./vendor-BZF0HjbR.js";import{B as w,C as B,a as $,b as H,c as L,p as P,q as V,r as U,s as h,t as W,v as p,S as z,i as J,j as O,k as Y,l as G}from"./shared-eQ5Wlos0.js";import{A as K}from"./AdminLayout-CLj11gFB.js";import{s as u}from"./index-opfOCVSx.js";import{u as c}from"./index-DaSXcfrj.js";import{R as v,f as Q,a as X,n as Z}from"./icons-BkT83dpJ.js";import"./utils-CfDMlrKu.js";import"./router-DmKwpzBq.js";import"./backend-DY5GQkp5.js";function ce(){const[b,d]=m.useState([]),[x,y]=m.useState(!1),[E,S]=m.useState(new Set),[f,g]=m.useState(new Map),[T,_]=m.useState(new Set),k=["invited","basic","pro","suite"],A={invited:"bg-gray-100 text-gray-700",basic:"bg-blue-100 text-blue-700",pro:"bg-purple-100 text-purple-700",suite:"bg-amber-100 text-amber-700"};m.useEffect(()=>{C()},[]);const C=async()=>{try{y(!0);const{data:s,error:n}=await u.from("user_buyers_with_email").select("*").order("created_at",{ascending:!1});if(!n&&s){d(s);return}const{data:a,error:r}=await u.from("user_buyers").select("id, email, full_name, tier, requested, created_at, user_id").order("created_at",{ascending:!1});if(!r&&a&&a.length>0&&a[0].email){const o=a.map(l=>({id:l.id,user_id:l.user_id||l.id,email:l.email,full_name:l.full_name||"Unknown",tier:l.tier,requested:l.requested,created_at:l.created_at}));d(o);return}const{data:t,error:i}=await u.from("user_buyers").select("*").order("created_at",{ascending:!1});if(i)throw i;if(!t||t.length===0){d([]);return}const R=t.map(o=>{const l=o.user_id||o.id,j=l?String(l):"unknown",N=j.length>8?j.substring(0,8):j;return{...o,user_id:l,email:o.email||`user_${N}@kstorybridge.com`,full_name:o.full_name||`User ${N}`}});d(R),n&&(console.log("View not available. Please run the migration to create user_buyers_with_email view."),c.info("To see actual email addresses, please run the database migration."))}catch(s){console.error("Error loading users:",s),c.error("Failed to load users")}finally{y(!1)}},q=(s,n)=>{g(a=>{const r=new Map(a);return r.set(s,n),r})},M=async s=>{const n=f.get(s);if(n)try{S(r=>new Set(r).add(s));const{error:a}=await u.from("user_buyers").update({tier:n}).eq("id",s);if(a)throw a;d(r=>r.map(t=>t.id===s?{...t,tier:n}:t)),g(r=>{const t=new Map(r);return t.delete(s),t}),c.success("User tier updated successfully")}catch(a){console.error("Error updating user tier:",a),c.error("Failed to update user tier")}finally{S(a=>{const r=new Set(a);return r.delete(s),r})}},D=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),F=async(s,n)=>{try{_(t=>new Set(t).add(s));const{error:a}=await u.from("user_buyers").update({tier:"basic"}).eq("id",s);if(a)throw a;const{error:r}=await u.functions.invoke("send-approval-email",{body:{email:n}});r?(console.error("Failed to send approval email:",r),c.warning("User approved but email notification failed")):c.success("User approved and email sent successfully!"),d(t=>t.map(i=>i.id===s?{...i,tier:"basic"}:i)),g(t=>{const i=new Map(t);return i.delete(s),i})}catch(a){console.error("Error approving user:",a),c.error("Failed to approve user")}finally{_(a=>{const r=new Set(a);return r.delete(s),r})}};return e.jsx(K,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-midnight-ink",children:"User Approval"}),e.jsxs(w,{onClick:C,variant:"outline",disabled:x,children:[e.jsx(v,{className:`h-4 w-4 mr-2 ${x?"animate-spin":""}`}),"Refresh"]})]}),e.jsxs(B,{children:[e.jsx($,{children:e.jsx(H,{children:"Buyer Users"})}),e.jsx(L,{children:x?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hanok-teal"})}):b.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No buyer users found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(P,{children:[e.jsx(V,{children:e.jsxs(U,{children:[e.jsx(h,{children:"Email"}),e.jsx(h,{children:"Current Tier"}),e.jsx(h,{children:"Change Tier"}),e.jsx(h,{children:"Requested Access"}),e.jsx(h,{children:"Joined"}),e.jsx(h,{children:"Action"})]})}),e.jsx(W,{children:b.map(s=>{const n=f.has(s.id),a=f.get(s.id),r=E.has(s.id),t=T.has(s.id);return e.jsxs(U,{children:[e.jsx(p,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.email,s.tier==="invited"&&e.jsx(w,{size:"sm",variant:"default",onClick:()=>F(s.id,s.email),disabled:t,className:"bg-green-600 hover:bg-green-700",children:t?e.jsx(v,{className:"h-3 w-3 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"Approve"]})})]})}),e.jsx(p,{children:s.tier?e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${A[s.tier]}`,children:s.tier.toUpperCase()}):e.jsx("span",{className:"text-gray-400",children:"Not set"})}),e.jsx(p,{children:e.jsxs(z,{value:a||s.tier||"",onValueChange:i=>q(s.id,i),disabled:r,children:[e.jsx(J,{className:"w-32",children:e.jsx(O,{placeholder:"Select tier"})}),e.jsx(Y,{children:k.map(i=>e.jsx(G,{value:i,children:i.charAt(0).toUpperCase()+i.slice(1)},i))})]})}),e.jsx(p,{children:s.requested?e.jsxs("span",{className:"text-green-600 flex items-center",children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Yes"]}):e.jsx("span",{className:"text-gray-400",children:"No"})}),e.jsx(p,{children:D(s.created_at)}),e.jsx(p,{children:e.jsx(w,{size:"sm",onClick:()=>M(s.id),disabled:!n||r,variant:n?"default":"outline",children:r?e.jsx(v,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Save"]})})})]},s.id)})})]})})})]})]})})}export{ce as default};
