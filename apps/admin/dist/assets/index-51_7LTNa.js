const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AdminLogin-k9nTxXkE.js","assets/ui-DHaiO8z9.js","assets/vendor-BZF0HjbR.js","assets/shared-oRVCA-__.js","assets/utils-CfDMlrKu.js","assets/icons-BVWbeyA4.js","assets/router-DmKwpzBq.js","assets/backend-DY5GQkp5.js","assets/AdminTitles-CXLLMXHH.js","assets/titlesService-B9xRPQpD.js","assets/featuredService-PjludKEt.js","assets/AdminLayout-nbEZqzxn.js","assets/index-DaSXcfrj.js","assets/AdminTitleDetail-CsolaTF3.js","assets/AdminTitleEdit-BWmL8Tgo.js","assets/AdminFeaturedTitles-CGPIehch.js","assets/AdminAddTitle-DIdMGBPv.js","assets/AdminScraperTest-C2o4JXID.js","assets/AdminUserApproval-BT-oEHnE.js"])))=>i.map(i=>d[i]);
import{j as e}from"./ui-DHaiO8z9.js";import{a as U,r as a}from"./vendor-BZF0HjbR.js";import{c as V,_ as N}from"./backend-DY5GQkp5.js";import{N as I,B as M,R as q,a as j}from"./router-DmKwpzBq.js";import{C as J,a as K,b as Y,c as H,B as R,d as _,T as $}from"./shared-oRVCA-__.js";import{e as P,R as k,S as O,f as X,g as Z,B as C}from"./icons-BVWbeyA4.js";import"./utils-CfDMlrKu.js";(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))x(t);new MutationObserver(t=>{for(const d of t)if(d.type==="childList")for(const h of d.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&x(h)}).observe(document,{childList:!0,subtree:!0});function m(t){const d={};return t.integrity&&(d.integrity=t.integrity),t.referrerPolicy&&(d.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?d.credentials="include":t.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function x(t){if(t.ep)return;t.ep=!0;const d=m(t);fetch(t.href,d)}})();var T,L=U;T=L.createRoot,L.hydrateRoot;const G="https://dlrnrgcoguxlkkcitlpd.supabase.co",W="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRscm5yZ2NvZ3V4bGtrY2l0bHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTIzMzQsImV4cCI6MjA2NzM2ODMzNH0.KWYF7TvoA0I3iyoIbyYIyTSlJcIyPH6yCfHueEEMIlA",y=V(G,W,{auth:{storageKey:"admin-auth-token",persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!1},global:{headers:{"X-Client-Info":"admin-portal"}}}),Q=a.createContext(void 0);function ee({children:r}){const[c,m]=a.useState(null),[x,t]=a.useState(null),[d,h]=a.useState(null),[A,u]=a.useState(!0),[v,l]=a.useState(null),f=()=>l(null),b=async n=>{try{console.log(`Admin Auth: Loading profile for ${n}`);const o=new Promise((w,B)=>{setTimeout(()=>B(new Error("Profile loading timeout")),1e4)}),s=y.from("admin").select("*").eq("email",n).eq("active",!0).maybeSingle(),{data:p,error:i}=await Promise.race([s,o]);if(i)throw console.error("Admin Auth: Profile query error:",i),i;p?(console.log("Admin Auth: Profile loaded successfully"),t(p),f()):(console.log("Admin Auth: No admin profile found"),l(`No admin access found for ${n}. Contact IT support.`),t(null))}catch(o){console.error("Admin Auth: Profile loading failed:",o);const s=o instanceof Error?o.message:"Unknown error";if(s==="Profile loading timeout"){console.log("Admin Auth: Timeout detected, attempting fallback...");try{const p={id:"temp-"+Date.now(),email:n,full_name:n.split("@")[0],active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};t(p),f(),console.log("Admin Auth: Fallback profile created")}catch{l("Profile loading timed out. Please refresh the page or clear your session."),t(null)}}else l(`Failed to load admin profile: ${s}`),t(null)}};a.useEffect(()=>{let n=!0;console.log("Admin Auth: Initializing...");const o=async()=>{var p;try{const{data:{session:i},error:w}=await y.auth.getSession();if(!n)return;if(w){console.error("Admin Auth: Session error:",w),l(`Session error: ${w.message}`),u(!1);return}console.log("Admin Auth: Initial session:",i?"Found":"None"),h(i),m((i==null?void 0:i.user)??null),(p=i==null?void 0:i.user)!=null&&p.email&&await b(i.user.email)}catch(i){console.error("Admin Auth: Initialize error:",i),l("Failed to initialize authentication")}finally{n&&u(!1)}},{data:{subscription:s}}=y.auth.onAuthStateChange(async(p,i)=>{var w;n&&(console.log(`Admin Auth: ${p}`,i?"Session exists":"No session"),h(i),m((i==null?void 0:i.user)??null),f(),p==="SIGNED_OUT"?(t(null),u(!1)):(w=i==null?void 0:i.user)!=null&&w.email?(u(!0),await b(i.user.email),u(!1)):(t(null),u(!1)))});return o(),()=>{n=!1,s.unsubscribe()}},[]);const F={user:c,adminProfile:x,session:d,isLoading:A,error:v,signIn:async(n,o)=>{try{u(!0),f(),console.log("Admin Auth: Signing in...");const{error:s}=await y.auth.signInWithPassword({email:n.trim(),password:o});return s?(console.error("Admin Auth: Sign in failed:",s),u(!1),{error:s}):(console.log("Admin Auth: Sign in successful"),{error:null})}catch(s){return console.error("Admin Auth: Sign in exception:",s),u(!1),{error:s instanceof Error?s:new Error("Sign in failed")}}},signOut:async()=>{try{console.log("Admin Auth: Signing out...");try{Object.keys(localStorage).filter(s=>s.startsWith("admin-")).forEach(s=>localStorage.removeItem(s)),console.log("Admin Auth: Cleared admin storage")}catch(n){console.warn("Admin Auth: Failed to clear admin storage:",n)}await y.auth.signOut(),m(null),t(null),h(null),f(),console.log("Admin Auth: Sign out completed")}catch(n){console.error("Admin Auth: Sign out error:",n)}},clearError:f,refreshAuth:async()=>{var n;try{console.log("Admin Auth: Refreshing..."),u(!0),f();const{data:{session:o},error:s}=await y.auth.getSession();if(s)throw s;h(o),m((o==null?void 0:o.user)??null),(n=o==null?void 0:o.user)!=null&&n.email?await b(o.user.email):t(null)}catch(o){console.error("Admin Auth: Refresh failed:",o),l("Failed to refresh authentication")}finally{u(!1)}},forceSignOut:async()=>{try{console.log("Admin Auth: Force signing out to clear stuck session...");try{Object.keys(localStorage).filter(s=>s.startsWith("admin-")||s.includes("dlrnrgcoguxlkkcitlpd")).forEach(s=>localStorage.removeItem(s)),console.log("Admin Auth: Force cleared all auth storage")}catch(n){console.warn("Admin Auth: Failed to clear storage:",n)}m(null),t(null),h(null),u(!1),f(),await y.auth.signOut(),console.log("Admin Auth: Force sign out completed")}catch(n){console.error("Admin Auth: Force sign out error:",n)}},retryProfileLoad:async()=>{c!=null&&c.email&&(console.log("Admin Auth: Retrying profile load..."),f(),await b(c.email))}};return e.jsx(Q.Provider,{value:F,children:r})}function z(){const r=a.useContext(Q);if(r===void 0)throw new Error("useAdminAuth must be used within an AdminAuthProvider");return r}function D(){var A,u,v;const[r,c]=a.useState(null),[m,x]=a.useState(!1),{retryProfileLoad:t}=z(),d=async()=>{x(!0),console.log("ðŸ” Running admin auth diagnostics...");try{const{data:{session:l},error:f}=await y.auth.getSession();if(console.log("Session check:",{session:!!l,error:f}),!l){c({hasSession:!1,userEmail:null,adminQueryResult:null,adminQueryError:null,suggestions:["User is not authenticated","Please log in with valid credentials"]});return}const{data:b,error:S}=await y.from("admin").select("*").eq("email",l.user.email).eq("active",!0);console.log("Admin query:",{data:b,error:S});const g=[];S?S.code==="PGRST116"?(g.push("No admin record found for this email"),g.push(`Add admin record: INSERT INTO public.admin (email, full_name, active) VALUES ('${l.user.email}', 'Admin User', true);`)):S.code==="42501"?(g.push("Permission denied - RLS policy issue"),g.push("Run the fix-admin-access.sql script to fix policies")):(g.push("Database connection or configuration issue"),g.push("Check Supabase connection and admin table existence")):!b||b.length===0?(g.push("Admin record exists but query returned no results"),g.push("Check if admin record is active and email matches exactly")):(g.push("Admin record found - authentication should work"),g.push("Check useAdminAuth hook implementation")),c({hasSession:!0,userEmail:l.user.email||null,adminQueryResult:b,adminQueryError:S,suggestions:g})}catch(l){console.error("Diagnostics failed:",l),c({hasSession:!1,userEmail:null,adminQueryResult:null,adminQueryError:l,suggestions:["Exception occurred during diagnostics","Check browser console for details"]})}finally{x(!1)}};a.useEffect(()=>{d()},[]);const h=l=>l?e.jsx(X,{className:"h-5 w-5 text-green-500"}):e.jsx(Z,{className:"h-5 w-5 text-red-500"});return e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6",children:e.jsxs(J,{className:"w-full max-w-2xl",children:[e.jsx(K,{children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-6 w-6 text-orange-500"}),"Admin Authentication Debug"]})}),e.jsxs(H,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Diagnostics"}),e.jsxs(R,{onClick:d,disabled:m,variant:"outline",size:"sm",children:[m?e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(k,{className:"h-4 w-4 mr-2"}),"Re-run"]})]}),r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-100 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Authentication Session"}),e.jsxs("div",{className:"flex items-center gap-2",children:[h(r.hasSession),e.jsx(_,{variant:r.hasSession?"default":"destructive",children:r.hasSession?"Active":"None"})]})]}),r.userEmail&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-100 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"User Email"}),e.jsx(_,{variant:"outline",children:r.userEmail})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-100 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Admin Record Query"}),e.jsxs("div",{className:"flex items-center gap-2",children:[h(!r.adminQueryError&&((A=r.adminQueryResult)==null?void 0:A.length)>0),e.jsx(_,{variant:!r.adminQueryError&&((u=r.adminQueryResult)==null?void 0:u.length)>0?"default":"destructive",children:!r.adminQueryError&&((v=r.adminQueryResult)==null?void 0:v.length)>0?"Found":"Failed"})]})]}),r.adminQueryError&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-red-800 mb-2",children:"Error Details"}),e.jsxs("p",{className:"text-sm text-red-700",children:[e.jsx("strong",{children:"Code:"})," ",r.adminQueryError.code||"Unknown"]}),e.jsxs("p",{className:"text-sm text-red-700",children:[e.jsx("strong",{children:"Message:"})," ",r.adminQueryError.message||"Unknown error"]})]}),r.adminQueryResult&&r.adminQueryResult.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-800 mb-2",children:"Admin Record Found"}),e.jsx("pre",{className:"text-xs text-green-700 bg-green-100 p-2 rounded overflow-x-auto",children:JSON.stringify(r.adminQueryResult[0],null,2)}),e.jsx("div",{className:"mt-3",children:e.jsxs(R,{onClick:t,size:"sm",className:"bg-green-600 hover:bg-green-700",children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Retry Profile Load"]})})]}),e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-800 mb-2",children:"Suggestions"}),e.jsx("ul",{className:"text-sm text-blue-700 space-y-1",children:r.suggestions.map((l,f)=>e.jsxs("li",{className:"flex",children:[e.jsx("span",{className:"mr-2",children:"â€¢"}),e.jsx("span",{className:"font-mono text-xs bg-blue-100 px-1 rounded",children:l})]},f))})]})]}):m?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(k,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-gray-600",children:"Running diagnostics..."})]}):null,e.jsx("div",{className:"text-center text-sm text-gray-500",children:"Check the browser console for detailed logs"})]})]})})}function E({children:r}){const{adminProfile:c,isLoading:m,user:x,error:t,clearError:d,refreshAuth:h,retryProfileLoad:A}=z(),[u,v]=a.useState(!1);return x&&!c&&(t||!m)?u?e.jsx(D,{}):e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-white to-porcelain-blue-50 flex items-center justify-center px-6",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 mx-auto",children:e.jsx(P,{className:"w-8 h-8 text-red-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-midnight-ink mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-midnight-ink-600 mb-4",children:"You are authenticated but do not have admin access. Contact IT support if you believe this is an error."}),e.jsxs("p",{className:"text-sm text-midnight-ink-400 mb-4",children:["Email: ",x.email]}),t&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-red-600 text-sm",children:t}),t.includes("timeout")&&e.jsx("button",{onClick:A,className:"mt-2 text-red-700 hover:underline text-sm font-medium block",children:"Retry Profile Load"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>v(!0),className:"flex items-center gap-2 mx-auto text-orange-600 hover:underline mb-4",children:[e.jsx(C,{className:"w-4 h-4"}),"Debug Authentication Issue"]}),e.jsx("button",{onClick:()=>window.location.href="/login",className:"text-hanok-teal hover:underline",children:"Back to Login"})]})]})}):m&&!c?e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-white to-porcelain-blue-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-16 h-16 bg-hanok-teal rounded-full flex items-center justify-center mb-4 mx-auto",children:e.jsx(O,{className:"w-8 h-8 text-white"})}),e.jsx("div",{className:"w-8 h-8 border-2 border-hanok-teal border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-midnight-ink-600 mb-2",children:"Verifying admin access..."}),t&&e.jsxs("div",{className:"mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsx("p",{className:"text-orange-600 text-sm",children:t}),e.jsx("button",{onClick:()=>{d(),t!=null&&t.includes("timeout")?A():h()},className:"mt-2 text-orange-700 hover:underline text-sm font-medium",children:t!=null&&t.includes("timeout")?"Retry Profile Load":"Retry Authentication"})]})]})}):x&&!c?u?e.jsx(D,{}):e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-white to-porcelain-blue-50 flex items-center justify-center px-6",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 mx-auto",children:e.jsx(P,{className:"w-8 h-8 text-red-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-midnight-ink mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-midnight-ink-600 mb-4",children:"You are authenticated but do not have admin access. Contact IT support if you believe this is an error."}),e.jsxs("p",{className:"text-sm text-midnight-ink-400 mb-4",children:["Email: ",x.email]}),t&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-red-600 text-sm",children:t}),t.includes("timeout")&&e.jsx("button",{onClick:A,className:"mt-2 text-red-700 hover:underline text-sm font-medium block",children:"Retry Profile Load"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>v(!0),className:"flex items-center gap-2 mx-auto text-orange-600 hover:underline mb-4",children:[e.jsx(C,{className:"w-4 h-4"}),"Debug Authentication Issue"]}),e.jsx("button",{onClick:()=>window.location.href="/login",className:"text-hanok-teal hover:underline",children:"Back to Login"})]})]})}):x?c?e.jsx(e.Fragment,{children:r}):e.jsx(I,{to:"/login",replace:!0}):e.jsx(I,{to:"/login",replace:!0})}const te=a.lazy(()=>N(()=>import("./AdminLogin-k9nTxXkE.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]))),re=a.lazy(()=>N(()=>import("./AdminTitles-CXLLMXHH.js"),__vite__mapDeps([8,1,2,6,3,4,5,9,10,11,12,7]))),se=a.lazy(()=>N(()=>import("./AdminTitleDetail-CsolaTF3.js"),__vite__mapDeps([13,1,2,3,4,5,9,11,6,7]))),ne=a.lazy(()=>N(()=>import("./AdminTitleEdit-BWmL8Tgo.js"),__vite__mapDeps([14,1,2,3,4,5,9,11,6,7]))),ie=a.lazy(()=>N(()=>import("./AdminFeaturedTitles-CGPIehch.js"),__vite__mapDeps([15,1,2,6,3,4,5,9,10,11,12,7]))),oe=a.lazy(()=>N(()=>import("./AdminAddTitle-DIdMGBPv.js"),__vite__mapDeps([16,1,2,3,4,5,9,11,6,12,7]))),ae=a.lazy(()=>N(()=>import("./AdminScraperTest-C2o4JXID.js"),__vite__mapDeps([17,1,2,3,4,5,11,6,12,7]))),le=a.lazy(()=>N(()=>import("./AdminUserApproval-BT-oEHnE.js"),__vite__mapDeps([18,1,2,3,4,5,11,6,12,7]))),ce=()=>e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hanok-teal"})});function de(){return e.jsxs(ee,{children:[e.jsx(M,{children:e.jsx(a.Suspense,{fallback:e.jsx(ce,{}),children:e.jsxs(q,{children:[e.jsx(j,{path:"/login",element:e.jsx(te,{})}),e.jsx(j,{path:"/titles",element:e.jsx(E,{children:e.jsx(re,{})})}),e.jsx(j,{path:"/titles/:titleId",element:e.jsx(E,{children:e.jsx(se,{})})}),e.jsx(j,{path:"/titles/:titleId/edit",element:e.jsx(E,{children:e.jsx(ne,{})})}),e.jsx(j,{path:"/featured-titles",element:e.jsx(E,{children:e.jsx(ie,{})})}),e.jsx(j,{path:"/titles/new",element:e.jsx(E,{children:e.jsx(oe,{})})}),e.jsx(j,{path:"/scraper-test",element:e.jsx(E,{children:e.jsx(ae,{})})}),e.jsx(j,{path:"/user-approval",element:e.jsx(E,{children:e.jsx(le,{})})}),e.jsx(j,{path:"/",element:e.jsx(I,{to:"/titles",replace:!0})}),e.jsx(j,{path:"*",element:e.jsx(I,{to:"/titles",replace:!0})})]})})}),e.jsx($,{})]})}T(document.getElementById("root")).render(e.jsx(a.StrictMode,{children:e.jsx(de,{})}));export{y as s,z as u};
